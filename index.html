
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <script src="https://cdn.tailwindcss.com">
function fetchStockPrices() {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  const codes = data.filter(a => a.category === 'è‚¡ç¥¨' || a.category === 'åŸºé‡‘')
    .map(a => a.code?.toLowerCase()).filter(Boolean);

  if (codes.length === 0) return;

  const url = 'https://qt.gtimg.cn/q=' + codes.join(',');
  fetch(url)
    .then(res => res.text())
    .then(text => {
      codes.forEach(code => {
        const match = text.match(new RegExp(`v_${code}="(.*?)";`));
        if (!match) return;
        const parts = match[1].split('~');
        const price = parseFloat(parts[3]);
        const name = parts[1];
        document.querySelectorAll(`[data-code="${code}"]`).forEach(card => {
          const shares = parseFloat(card.getAttribute('data-shares'));
          const value = (price * shares).toFixed(2);
          card.querySelector('.price').textContent = `ç°ä»· Â¥${price}`;
          card.querySelector('.value').textContent = `å¸‚å€¼ Â¥${value}`;
        });
      });
    });
}
setInterval(fetchStockPrices, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
document.querySelector('[data-tab="assets"]').addEventListener('click', () => {
  setTimeout(() => {
    loadAssets();
    fetchStockPrices();
  }, 100);
});
</script>
  <style>body { background-color: #f9fafb; }</style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js">
// ç”Ÿæˆåˆ†ç±»é¥¼å›¾å’Œæœˆåº¦æŠ˜çº¿å›¾
function renderCharts() {
  const data = JSON.parse(localStorage.getItem('records') || '[]');

  // åˆ†ç±»æ±‡æ€»ï¼ˆæ”¶å…¥ vs æ”¯å‡ºï¼‰
  const incomeMap = {}, expenseMap = {};
  const monthlyMap = {};

  data.forEach(item => {
    const month = item.date?.slice(0, 7); // YYYY-MM
    const amt = parseFloat(item.amount);
    if (!month || isNaN(amt)) return;

    // åˆ†ç±»æ•°æ®
    const catMap = item.type === 'income' ? incomeMap : expenseMap;
    catMap[item.category] = (catMap[item.category] || 0) + amt;

    // æœˆåº¦æ•°æ®
    if (!monthlyMap[month]) monthlyMap[month] = { income: 0, expense: 0 };
    monthlyMap[month][item.type] += amt;
  });

  // é¥¼å›¾ - åˆ†ç±»
  const catLabels = Array.from(new Set([...Object.keys(expenseMap), ...Object.keys(incomeMap)]));
  const incomeData = catLabels.map(k => incomeMap[k] || 0);
  const expenseData = catLabels.map(k => expenseMap[k] || 0);

  new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
      labels: catLabels,
      datasets: [
        { label: 'æ”¯å‡º', data: expenseData, backgroundColor: '#ef4444' },
        { label: 'æ”¶å…¥', data: incomeData, backgroundColor: 'rgba(75,192,192,0.6)' }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: 'åˆ†ç±»æ”¶æ”¯å æ¯”' } }
    }
  });

  // æŠ˜çº¿å›¾ - æœˆåº¦è¶‹åŠ¿
  const months = Object.keys(monthlyMap).sort();
  const incomeTrend = months.map(m => monthlyMap[m].income);
  const expenseTrend = months.map(m => monthlyMap[m].expense);

  new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        { label: 'æ”¶å…¥', data: incomeTrend, borderColor: 'green', tension: 0.3 },
        { label: 'æ”¯å‡º', data: expenseTrend, borderColor: 'red', tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: 'æœˆåº¦æ”¶æ”¯è¶‹åŠ¿' } }
    }
  });
}

// æ¯æ¬¡åˆ‡æ¢åˆ°æŠ¥è¡¨é¡µé¢æ—¶åˆ·æ–°å›¾è¡¨
document.querySelector('[data-tab="reports"]').addEventListener('click', () => {
  setTimeout(renderCharts, 100); // å»¶è¿Ÿç¡®ä¿ canvas å·²æ¸²æŸ“
});

// ===== è´Ÿå€ºåŠŸèƒ½ =====
function loadDebts() {
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  const container = document.getElementById('debtCards');
  container.innerHTML = '';
  let summary = {};
  data.forEach((debt, index) => {
    summary[debt.category] = (summary[debt.category] || 0) + parseFloat(debt.amount);
    const card = document.createElement('div');
    card.className = 'bg-white shadow rounded-xl p-4 border-l-4 border-red-500';
    card.innerHTML = `<strong>${debt.name}</strong><br>Â¥${parseFloat(debt.amount).toFixed(2)}<br><small>${debt.category}</small><br><button onclick="deleteDebt(${index})" style='margin-top:5px;'>ğŸ—‘ åˆ é™¤</button>`;
    container.appendChild(card);
  });

  const ctx = document.getElementById('debtChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(summary),
        datasets: [{
          label: 'å„ç±»è´Ÿå€ºé‡‘é¢',
          data: Object.values(summary),
          backgroundColor: '#ef4444'
        }]
      },
      options: {
        plugins: { title: { display: true, text: 'è´Ÿå€ºåˆ†ç±»ç»Ÿè®¡å›¾' } },
        responsive: true
      }
    });
  }
}

document.getElementById('debtForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const name = document.getElementById('debtName').value;
  const amount = document.getElementById('debtAmount').value;
  const category = document.getElementById('debtCategory').value;
  if (!name || !amount) return alert('è¯·è¾“å…¥å®Œæ•´è´Ÿå€ºä¿¡æ¯');
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  let code = "";
  if (category === "è‚¡ç¥¨" || category === "åŸºé‡‘") {
    code = prompt("è¯·è¾“å…¥è‚¡ç¥¨/åŸºé‡‘ä»£ç ï¼ˆå¦‚ sh600519, usAAPL, hk0700, f110011ï¼‰", "");
    if (!code) return alert("è‚¡ç¥¨æˆ–åŸºé‡‘å¿…é¡»å¡«å†™ä»£ç ");
  }
  data.push({ name, amount, category, code });
  localStorage.setItem('debts', JSON.stringify(data));
  this.reset();
  loadDebts();
});

function deleteDebt(index) {
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  data.splice(index, 1);
  localStorage.setItem('debts', JSON.stringify(data));
  loadDebts();
}

document.querySelector('[data-tab="liabilities"]').addEventListener('click', () => {
  setTimeout(loadDebts, 100);
});

// ç¼–è¾‘è‚¡ç¥¨/åŸºé‡‘æŒä»“è‚¡æ•°
function editShares(index) {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  const asset = data[index];
  const input = prompt("è¯·è¾“å…¥æ–°çš„æŒä»“è‚¡æ•° / ä»½é¢ï¼š", asset.amount);
  if (!input || isNaN(input)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
  asset.amount = parseFloat(input).toFixed(2);
  localStorage.setItem('assets', JSON.stringify(data));
  loadAssets();
  fetchStockPrices();
}

// ===== èµ„äº§åŠŸèƒ½ =====
function loadAssets() {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  const container = document.getElementById('assetCards');
  container.innerHTML = '';
  let summary = {};
  let total = 0;
  data.forEach((asset, index) => {
    total += parseFloat(asset.amount);
    summary[asset.category] = (summary[asset.category] || 0) + parseFloat(asset.amount);
    const card = document.createElement('div');
    card.className = 'bg-white shadow rounded-xl p-4 border-l-4 border-blue-500';
    if (asset.category === 'è‚¡ç¥¨' || asset.category === 'åŸºé‡‘') {
      card.setAttribute('data-code', (asset.code || '').toLowerCase());
      card.setAttribute('data-shares', asset.amount);
      card.innerHTML = `<strong>${asset.name}</strong>
  <br><span class="price text-sm text-gray-600">æ­£åœ¨åŠ è½½ä»·æ ¼...</span>
  <br><span class="value font-semibold text-blue-600">å¸‚å€¼ --</span>
  <br><small>${asset.category} Â· ${asset.code}</small>
  <br><button onclick="editShares(${index})" class="mt-1 mr-2 text-blue-600 hover:underline text-sm">âœï¸ ç¼–è¾‘</button>
  <button onclick="deleteAsset(${index})" class="mt-1 text-red-600 hover:underline text-sm">ğŸ—‘ åˆ é™¤</button>`;
        <br><span class="price text-sm text-gray-600">æ­£åœ¨åŠ è½½ä»·æ ¼...</span>
        <br><span class="value font-semibold text-blue-600">å¸‚å€¼ --</span>
        <br><small>${asset.category} Â· ${asset.code}</small>
        <br><button onclick="deleteAsset(${index})" class="mt-2 text-red-600 hover:underline text-sm">ğŸ—‘ åˆ é™¤</button>`;
    } else {
      card.innerHTML = `<strong>${asset.name}</strong>
  <br><span class="price text-sm text-gray-600">æ­£åœ¨åŠ è½½ä»·æ ¼...</span>
  <br><span class="value font-semibold text-blue-600">å¸‚å€¼ --</span>
  <br><small>${asset.category} Â· ${asset.code}</small>
  <br><button onclick="editShares(${index})" class="mt-1 mr-2 text-blue-600 hover:underline text-sm">âœï¸ ç¼–è¾‘</button>
  <button onclick="deleteAsset(${index})" class="mt-1 text-red-600 hover:underline text-sm">ğŸ—‘ åˆ é™¤</button>`;<br>Â¥${parseFloat(asset.amount).toFixed(2)}<br><small>${asset.category}</small><br><button onclick="deleteAsset(${index})" class="mt-2 text-red-600 hover:underline text-sm">ğŸ—‘ åˆ é™¤</button>`;
    } onclick="deleteAsset(${index})" style='margin-top:5px;'>ğŸ—‘ åˆ é™¤</button>`;
    container.appendChild(card);
  });

  // åˆ†ç±»ç»Ÿè®¡å›¾è¡¨
  const ctx = document.getElementById('assetChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(summary),
        datasets: [{
          label: 'å„ç±»èµ„äº§é‡‘é¢',
          data: Object.values(summary),
          backgroundColor: '#3b82f6'
        }]
      },
      options: {
        plugins: { title: { display: true, text: 'èµ„äº§åˆ†ç±»ç»Ÿè®¡å›¾' } },
        responsive: true
      }
    });
  }
}

document.getElementById('assetForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const name = document.getElementById('assetName').value;
  const amount = document.getElementById('assetAmount').value;
  const category = document.getElementById('assetCategory').value;
  if (!name || !amount) return alert('è¯·è¾“å…¥å®Œæ•´èµ„äº§ä¿¡æ¯');
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  let code = "";
  if (category === "è‚¡ç¥¨" || category === "åŸºé‡‘") {
    code = prompt("è¯·è¾“å…¥è‚¡ç¥¨/åŸºé‡‘ä»£ç ï¼ˆå¦‚ sh600519, usAAPL, hk0700, f110011ï¼‰", "");
    if (!code) return alert("è‚¡ç¥¨æˆ–åŸºé‡‘å¿…é¡»å¡«å†™ä»£ç ");
  }
  data.push({ name, amount, category, code });
  localStorage.setItem('assets', JSON.stringify(data));
  this.reset();
  loadAssets();
});

// åˆ é™¤èµ„äº§å‡½æ•°
function deleteAsset(index) {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  data.splice(index, 1);
  localStorage.setItem('assets', JSON.stringify(data));
  loadAssets();
}

// åŠ è½½èµ„äº§æ•°æ®
document.querySelector('[data-tab="assets"]').addEventListener('click', () => {
  setTimeout(loadAssets, 100);
});

// ===== CSV å¯¼å‡ºåŠŸèƒ½ =====
function exportCSV(type) {
  const map = {
    assets: ['name', 'amount', 'category'],
    debts: ['name', 'amount', 'category'],
    records: ['type', 'amount', 'category', 'date', 'note']
  };
  const headers = map[type];
  const data = JSON.parse(localStorage.getItem(type) || '[]');
  if (!data.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');

  const csvRows = [headers.join(',')];
  data.forEach(item => {
    const row = headers.map(h => `"${(item[h] ?? '').toString().replace(/"/g, '""')}"`);
    csvRows.push(row.join(','));
  });
  const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${type}.csv`;
  link.click();
}

// ===== CSV å¯¼å…¥åŠŸèƒ½ =====
function importCSV() {
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if (!file || !file.name.endsWith('.csv')) return alert('è¯·é€‰æ‹©ä¸€ä¸ª CSV æ–‡ä»¶');

  const reader = new FileReader();
  reader.onload = function (e) {
    const lines = e.target.result.split('\n').filter(l => l.trim());
    const headers = lines[0].split(',').map(h => h.trim());
    const records = lines.slice(1).map(line => {
      const cols = line.split(',');
      const item = {};
      headers.forEach((h, i) => item[h] = cols[i]?.replace(/^"|"$/g, '').trim());
      return item;
    });

    let key = '';
    if (file.name.startsWith('assets')) key = 'assets';
    else if (file.name.startsWith('debts')) key = 'debts';
    else if (file.name.startsWith('records')) key = 'records';
    else return alert('æ–‡ä»¶åå¿…é¡»ä¸º assets.csvã€debts.csv æˆ– records.csv');

    localStorage.setItem(key, JSON.stringify(records));
    alert('å¯¼å…¥æˆåŠŸï¼š' + file.name);
  };
  reader.readAsText(file);
}
// ===== ç†è´¢æœˆå†åŠŸèƒ½ =====
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-11

function changeMonth(offset) {
  currentMonth += offset;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  generateCalendar();
updateBudgetBar();
}

function generateCalendar() {
  const year = currentYear;
  const month = currentMonth;
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startWeekday = firstDay.getDay(); // 0 (Sun) - 6 (Sat)
  const calendarGrid = document.getElementById('calendarGrid');
  const calendarMonth = document.getElementById('calendarMonth');

  calendarGrid.innerHTML = '';
  calendarMonth.textContent = `${year}å¹´${month + 1}æœˆ`;

  // è·å–æœ‰è®°è´¦è®°å½•çš„æ—¥æœŸé›†åˆ
  const records = JSON.parse(localStorage.getItem('records') || '[]');
  const markedDates = new Set(records.map(r => r.date));

  // å¡«å……ç©ºç™½
  for (let i = 0; i < startWeekday; i++) {
    const empty = document.createElement('div');
    calendarGrid.appendChild(empty);
  }

  // å¡«å……æ—¥æœŸ
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    const cell = document.createElement('div');
    cell.textContent = d;
    cell.style.padding = '10px';
    cell.style.textAlign = 'center';
    cell.style.borderRadius = '4px';
    cell.style.border = '1px solid #eee';
    if (markedDates.has(dateStr)) {
      cell.style.backgroundColor = '#165DFF';
      cell.style.color = '#fff';
      cell.style.fontWeight = 'bold';
    }
    calendarGrid.appendChild(cell);
  }
}

generateCalendar();
updateBudgetBar();
// ===== æœˆåº¦é¢„ç®—è¿›åº¦æ¡ =====
function updateBudgetBar() {
  const records = JSON.parse(localStorage.getItem('records') || '[]');
  const year = currentYear;
  const month = (currentMonth + 1).toString().padStart(2, '0');
  const prefix = `${year}-${month}`;
  const expenses = records
    .filter(r => r.type === 'expense' && r.date?.startsWith(prefix))
    .reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
  const budget = 5000; // é»˜è®¤é¢„ç®—ï¼Œå¯æ”¹ä¸ºå¯è®¾ç½®
  const percent = Math.min((expenses / budget) * 100, 100).toFixed(1);
  const bar = document.getElementById('budgetBar');
  bar.style.width = percent + '%';
  bar.textContent = `Â¥${expenses.toFixed(2)} / Â¥${budget}`;
  bar.style.backgroundColor = percent > 80 ? '#f44336' : '#165DFF';
}="(.*?)";`));
        if (!match) return;
        const parts = match[1].split('~');
        const price = parseFloat(parts[3]);
        const name = parts[1];
        document.querySelectorAll(`[data-code="${code}"]`).forEach(card => {
          const shares = parseFloat(card.getAttribute('data-shares'));
          const value = (price * shares).toFixed(2);
          card.querySelector('.price').textContent = `ç°ä»· Â¥${price}`;
          card.querySelector('.value').textContent = `å¸‚å€¼ Â¥${value}`;
        });
      });
    });
}
setInterval(fetchStockPrices, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
document.querySelector('[data-tab="assets"]').addEventListener('click', () => {
  setTimeout(() => {
    loadAssets();
    fetchStockPrices();
  }, 100);
});
</script>
  <meta charset="UTF-8">
  <title>æç®€ç†è´¢ - è®°è´¦åŠŸèƒ½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 0; background: #f5f6f8; }
    header { background: white; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 1.25rem; }
    nav { display: flex; border-bottom: 1px solid #ddd; }
    .tab-btn {
      flex: 1; padding: 12px; text-align: center; cursor: pointer;
      border-bottom: 2px solid transparent; font-weight: bold; background: #fff;
    }
    .tab-btn.active { border-color: #165DFF; color: #165DFF; }
    main { padding: 20px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }

    form input, form select, form button {
      padding: 8px; margin: 6px 0; width: 100%; box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 0.9rem; }
    th { background: #f0f0f0; }
    .income { color: green; }
    .expense { color: red; }
  </style>
</head>
<body>
  
    <h1>æç®€ç†è´¢</h1>
  </header>
  
    <div class="tab-btn active" data-tab="dashboard">æ€»è§ˆ</div>
    <div class="tab-btn" data-tab="assets">èµ„äº§</div>
    <div class="tab-btn" data-tab="liabilities">è´Ÿå€º</div>
    <div class="tab-btn" data-tab="reports">æŠ¥è¡¨</div>
    <div class="tab-btn" data-tab="profile">æˆ‘çš„</div>
  </nav>
  <main>
    <section id="dashboard" class="tab-content">
      <!-- æ€»èµ„äº§å¡ç‰‡å’Œç†è´¢æœˆå† -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
        <div class="lg:col-span-7 bg-white rounded-xl p-6 card-shadow asset-card slide-in">
          <div class="card-header mb-6">
            <h2 class="text-xl font-bold">æ€»èµ„äº§</h2>
            <div class="flex space-x-3">
              <button class="text-primary text-sm hover:underline action-btn flex items-center">
                <i class="fa fa-bar-chart mr-1"></i> è¯¦æƒ…
              </button>
              <button class="text-primary text-sm hover:underline action-btn flex items-center">
                <i class="fa fa-pie-chart mr-1"></i> åˆ†æ
              </button>
            </div>
          </div>
          
          <div class="flex items-end mb-6">
            <span class="text-4xl font-bold number-animation number-transition number-counter" id="totalAssets">Â¥1,258,634.25</span>
            <div class="ml-4">
              <div class="text-success flex items-center text-sm">
                <i class="fa fa-arrow-up mr-1"></i> 2.3% <span class="text-dark-light ml-1">æœ¬å‘¨</span>
              </div>
              <div class="text-dark-light text-sm mt-1">+Â¥12,345.67 ä»Šæ—¥</div>
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-ultra-light rounded-lg p-4">
              <div class="text-dark-light text-xs mb-1">æ´»æœŸå­˜æ¬¾</div>
              <div class="font-medium">Â¥286,345.25</div>
            </div>
            <div class="bg-ultra-light rounded-lg p-4">
              <div class="text-dark-light text-xs mb-1">å®šæœŸå­˜æ¬¾</div>
              <div class="font-medium">Â¥500,000.00</div>
            </div>
            <div class="bg-ultra-light rounded-lg p-4">
              <div class="text-dark-light text-xs mb-1">æŠ•èµ„</div>
              <div class="font-medium">Â¥472,289.00</div>
            </div>
          </div>
          
          <div class="mt-6 h-56">
            <canvas id="assetTrendChart"></canvas>
          </div>
        </div>
        
        <!-- ç†è´¢æœˆå† -->
        <div class="lg:col-span-5 bg-white rounded-xl p-6 card-shadow card-hover slide-in gradient-bg" style="animation-delay: 0.1s">
          <div class="calendar-header">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold">ç†è´¢æœˆå†</h2>
              <div class="flex space-x-2">
                <button class="p-2 rounded-full hover:bg-ultra-light transition-colors month-navigation" id="prevMonth">
                  <i class="fa fa-chevron-left text-dark-light"></i>
                </button>
                <button class="p-2 rounded-full hover:bg-ultra-light transition-colors month-navigation" id="nextMonth">
                  <i class="fa fa-chevron-right text-dark-light"></i>
                </button>
              </div>
            </div>
            
            <!-- æœˆåº¦è´¢åŠ¡æ¦‚è§ˆ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
              <div class="bg-white rounded-xl p-4 financial-stats-card income-gradient stat-card">
                <div class="text-dark-light text-xs">æ”¶å…¥</div>
                <div class="text-success font-medium mt-1 flex justify-between items-center">
                  <span>Â¥28,654</span>
                  <div class="flex items-center">
                    <i class="fa fa-arrow-up text-xs mr-1"></i>
                    <span class="text-xs">8.5%</span>
                  </div>
                </div>
              </div>
              <div class="bg-white rounded-xl p-4 financial-stats-card expense-gradient stat-card">
                <div class="text-dark-light text-xs">æ”¯å‡º</div>
                <div class="text-danger font-medium mt-1 flex justify-between items-center">
                  <span>Â¥16,325</span>
                  <div class="flex items-center">
                    <i class="fa fa-arrow-down text-xs mr-1"></i>
                    <span class="text-xs">3.2%</span>
                  </div>
                </div>
              </div>
              <div class="bg-white rounded-xl p-4 financial-stats-card balance-gradient stat-card">
                <div class="text-dark-light text-xs">ç»“ä½™</div>
                <div class="text-primary font-medium mt-1 flex justify-between items-center">
                  <span>Â¥12,328</span>
                  <i class="fa fa-balance-scale text-xs"></i>
                </div>
              </div>
            </div>
            
            <!-- æœˆåº¦è¶‹åŠ¿å›¾ -->
            <div class="bg-white rounded-xl p-4 mb-6 financial-stats-card stat-card">
              <div class="text-dark-light text-xs mb-2">æ”¶æ”¯è¶‹åŠ¿</div>
              <div class="financial-trend-chart">
                <canvas id="monthlyTrendChart"></canvas>
              </div>
            </div>
            
            <div class="mb-4 text-center">
              <h3 class="font-bold text-lg" id="currentMonth">2025å¹´6æœˆ</h3>
            </div>
            
            <div class="grid grid-cols-7 gap-1 mb-3">
              <div class="text-center text-dark-light text-sm py-2 font-medium">æ—¥</div>
              <div class="text-center text-dark-light text-sm py-2 font-medium">ä¸€</div>
              <div class="text-center text-dark-light text-sm py-2 font-medium">äºŒ</div>
              <div class="text-center text-dark-light text-sm py-2 font-medium">ä¸‰</div>
              <div class="text-center text-dark-light text-sm py-2 font-medium">å››</div>
              <div class="text-center text-dark-light text-sm py-2 font-medium">äº”</div>
              <div class="text-center text-dark-light text-sm py-2 font-medium">å…­</div>
            </div>
          </div>
          
          <div class="calendar-body relative overflow-hidden">
            <div class="grid grid-cols-7 gap-2 calendar-transition" id="calendarDays">
              <!-- æ—¥å†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          
          <!-- ä¼˜åŒ–åçš„å›¾ä¾‹å¸ƒå±€ -->
          <div class="mt-4 p-3 bg-ultra-light/50 rounded-lg">
            <div class="flex flex-wrap justify-center gap-x-6 gap-y-2">
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-success mr-2"></div>
                <span class="text-sm text-dark-light">æ”¶å…¥</span>
              </div>
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-danger mr-2"></div>
                <span class="text-sm text-dark-light">æ”¯å‡º</span>
              </div>
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-primary mr-2"></div>
                <span class="text-sm text-dark-light">è¿˜æ¬¾æ—¥</span>
              </div>
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-primary/70 border border-primary mr-2"></div>
                <span class="text-sm text-dark-light">ä»Šå¤©</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å¿«æ·æ“ä½œåŒº -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <button class="bg-white rounded-xl p-6 card-shadow hover-scale slide-in" style="animation-delay: 0.2s">
          <div class="flex items-center">
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-4">
              <i class="fa fa-exchange text-xl"></i>
            </div>
            <div>
              <h3 class="font-medium">è´¦æˆ·è½¬è´¦</h3>
              <p class="text-dark-light text-sm mt-1">åœ¨ä¸åŒè´¦æˆ·é—´å¿«é€Ÿè½¬è´¦</p>
            </div>
          </div>
        </button>
        
        <button class="bg-white rounded-xl p-6 card-shadow hover-scale slide-in" style="animation-delay: 0.3s">
          <div class="flex items-center">
            <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center text-warning mr-4">
              <i class="fa fa-credit-card text-xl"></i>
            </div>
            <div>
              <h3 class="font-medium">ä¿¡ç”¨å¡è¿˜æ¬¾</h3>
              <p class="text-dark-light text-sm mt-1">åŠæ—¶è¿˜æ¬¾ï¼Œé¿å…é€¾æœŸ</p>
            </div>
          </div>
        </button>
        
        <button class="bg-white rounded-xl p-6 card-shadow hover-scale slide-in" style="animation-delay: 0.4s">
          <div class="flex items-center">
            <div class="w-12 h-12 rounded-full bg-success/10 flex items-center justify-center text-success mr-4">
              <i class="fa fa-line-chart text-xl"></i>
            </div>
            <div>
              <h3 class="font-medium">æŠ•èµ„ç»„åˆ</h3>
              <p class="text-dark-light text-sm mt-1">æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„æŠ•èµ„</p>
            </div>
          </div>
        </button>
      </div>

      <!-- é¢„ç®—è¿›åº¦ -->
      <div class="bg-white rounded-xl p-6 card-shadow card-hover slide-in mb-6" style="animation-delay: 0.15s">
        <div class="card-header mb-6">
          <h2 class="text-xl font-bold">æœ¬æœˆé¢„ç®—è¿›åº¦</h2>
          <button class="text-primary text-sm hover:underline action-btn flex items-center">
            <i class="fa fa-cog mr-1"></i> è®¾ç½®é¢„ç®—
          </button>
        </div>
        
        <div class="space-y-5">
          <div>
            <div class="flex justify-between mb-2">
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-warning mr-2"></div>
                <span class="font-medium">é¤é¥®</span>
              </div>
              <span class="text-dark-light text-sm">Â¥2,550 / Â¥3,000</span>
            </div>
            <div class="budget-progress-bar">
              <div class="budget-progress bg-warning" style="width: 85%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-2">
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-danger mr-2"></div>
                <span class="font-medium">è´­ç‰©</span>
              </div>
              <span class="text-dark-light text-sm">Â¥4,825 / Â¥5,000</span>
            </div>
            <div class="budget-progress-bar">
              <div class="budget-progress bg-danger" style="width: 96%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-2">
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-success mr-2"></div>
                <span class="font-medium">äº¤é€š</span>
              </div>
              <span class="text-dark-light text-sm">Â¥650 / Â¥1,000</span>
            </div>
            <div class="budget-progress-bar">
              <div class="budget-progress bg-success" style="width: 65%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-2">
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-primary mr-2"></div>
                <span class="font-medium">å¨±ä¹</span>
              </div>
              <span class="text-dark-light text-sm">Â¥1,200 / Â¥2,000</span>
            </div>
            <div class="budget-progress-bar">
              <div class="budget-progress bg-primary" style="width: 60%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- æœ¬æœˆæ”¶æ”¯æ¦‚è§ˆ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-xl p-6 card-shadow card-hover slide-in" style="animation-delay: 0.5s">
          <div class="card-header mb-6">
            <h2 class="text-xl font-bold">æœ¬æœˆæ”¶å…¥</h2>
            <button class="text-primary text-sm hover:underline action-btn flex items-center">
              <i class="fa fa-list mr-1"></i> æŸ¥çœ‹è¯¦æƒ…
            </button>
          </div>
          <div class="flex items-end mb-6">
            <span class="text-3xl font-bold number-animation number-counter">Â¥28,654.32</span>
            <span class="text-dark-light ml-2 mb-0.5">è¾ƒä¸Šæœˆ</span>
          </div>
          <div class="mt-6 grid grid-cols-3 gap-3">
            <div class="bg-ultra-light rounded-lg p-4 text-center">
              <div class="text-dark-light text-xs mb-1">å·¥èµ„</div>
              <div class="font-medium">Â¥25,000</div>
            </div>
            <div class="bg-ultra-light rounded-lg p-4 text-center">
              <div class="text-dark-light text-xs mb-1">æŠ•èµ„</div>
              <div class="font-medium">Â¥3,254</div>
            </div>
            <div class="bg-ultra-light rounded-lg p-4 text-center">
              <div class="text-dark-light text-xs mb-1">å…¶ä»–</div>
              <div class="font-medium">Â¥400.32</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 card-shadow card-hover slide-in" style="animation-delay: 0.6s">
          <div class="card-header mb-6">
            <h2 class="text-xl font-bold">æœ¬æœˆæ”¯å‡º</h2>
            <button class="text-primary text-sm hover:underline action-btn flex items-center">
              <i class="fa fa-list mr-1"></i> æŸ¥çœ‹è¯¦æƒ…
            </button>
          </div>
          <div class="flex items-end mb-6">
            <span class="text-3xl font-bold number-animation number-counter">Â¥16,325.78</span>
            <span class="text-dark-light ml-2 mb-0.5">è¾ƒä¸Šæœˆ</span>
          </div>
          <div class="mt-6 grid grid-cols-3 gap-3">
            <div class="bg-ultra-light rounded-lg p-4 text-center">
              <div class="text-dark-light text-xs mb-1">ç”Ÿæ´»</div>
              <div class="font-medium">Â¥6,500</div>
            </div>
            <div class="bg-ultra-light rounded-lg p-4 text-center">
              <div class="text-dark-light text-xs mb-1">è´­ç‰©</div>
              <div class="font-medium">Â¥4,825</div>
            </div>
            <div class="bg-ultra-light rounded-lg p-4 text-center">
              <div class="text-dark-light text-xs mb-1">å…¶ä»–</div>
              <div class="font-medium">Â¥4,900.78</div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ¶ˆæ¯ä¸­å¿ƒ -->
      <div class="bg-white rounded-xl p-6 card-shadow card-hover slide-in" style="animation-delay: 0.7s">
        <div class="card-header mb-6">
          <h2 class="text-xl font-bold">æ¶ˆæ¯ä¸­å¿ƒ</h2>
          <button class="text-primary text-sm hover:underline action-btn flex items-center">
            <i class="fa fa-angle-right mr-1"></i> æŸ¥çœ‹å…¨éƒ¨
          </button>
        </div>
        
        <div class="space-y-4">
          <div class="flex items-start p-4 rounded-xl bg-ultra-light/50 hover:bg-ultra-light transition-colors">
            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-4 flex-shrink-0">
              <i class="fa fa-bell-o"></i>
            </div>
            <div class="flex-grow">
              <div class="flex justify-between">
                <h3 class="font-medium">ä¿¡ç”¨å¡è¿˜æ¬¾æé†’</h3>
                <span class="text-dark-light text-xs">10åˆ†é’Ÿå‰</span>
              </div>
              <p class="text-dark-light text-sm mt-1">æ‚¨çš„æ‹›å•†é“¶è¡Œä¿¡ç”¨å¡ï¼ˆ****5678ï¼‰å°†äº3å¤©ååˆ°æœŸï¼Œéœ€è¿˜æ¬¾Â¥3,562.89</p>
            </div>
          </div>
          
          <div class="flex items-start p-4 rounded-xl bg-ultra-light/50 hover:bg-ultra-light transition-colors">
            <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center text-success mr-4 flex-shrink-0">
              <i class="fa fa-line-chart"></i>
            </div>
            <div class="flex-grow">
              <div class="flex justify-between">
                <h3 class="font-medium">æŠ•èµ„æ”¶ç›Šæé†’</h3>
                <span class="text-dark-light text-xs">2å°æ—¶å‰</span>
              </div>
              <p class="text-dark-light text-sm mt-1">æ‚¨çš„åŸºé‡‘ç»„åˆï¼ˆæ˜“æ–¹è¾¾è“ç­¹ç²¾é€‰æ··åˆï¼‰ä»Šæ—¥æ”¶ç›Š+Â¥245</p>
            </div>
          </div>
          
          <div class="flex items-start p-4 rounded-xl bg-ultra-light/50 hover:bg-ultra-light transition-colors">
            <div class="w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center text-warning mr-4 flex-shrink-0">
              <i class="fa fa-exclamation-triangle"></i>
            </div>
            <div class="flex-grow">
              <div class="flex justify-between">
                <h3 class="font-medium">é¢„ç®—é¢„è­¦</h3>
                <span class="text-dark-light text-xs">æ˜¨å¤©</span>
              </div>
              <p class="text-dark-light text-sm mt-1">æ‚¨çš„è´­ç‰©é¢„ç®—å·²ä½¿ç”¨96%ï¼Œè¯·æ³¨æ„æ§åˆ¶æ”¯å‡º</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="assets" class="tab-content">
<div class="bg-white rounded-xl shadow p-6 space-y-4">
<div class="bg-white rounded-xl shadow p-6 space-y-4">
  <h2>æˆ‘çš„èµ„äº§</h2>
  <form id="assetForm" style="margin-bottom: 20px;">
    <input type="text" id="assetName" placeholder="èµ„äº§åç§°ï¼ˆå¦‚ å·¥å•†é“¶è¡Œå¡ï¼‰" required>
    <input type="number" id="assetAmount" placeholder="é‡‘é¢" required>
    <select id="assetCategory">
      <option value="ç°é‡‘">ç°é‡‘</option>
      <option value="å‚¨è“„">å‚¨è“„</option>
      <option value="æŠ•èµ„">æŠ•èµ„</option>
      <option value="æ•°å­—èµ„äº§">æ•°å­—èµ„äº§</option>
    <option value="è‚¡ç¥¨">è‚¡ç¥¨</option>
    <option value="åŸºé‡‘">åŸºé‡‘</option>
    </select>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">æ·»åŠ èµ„äº§</button>
  </form>
  <div id="assetCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
  </div><div class="bg-white rounded-xl shadow p-4 mt-4"></div><div class="bg-white rounded-xl shadow p-4 mt-4"><canvas id="assetChart" height="180" style="margin-top: 30px;"></canvas>

      <h2>èµ„äº§</h2><p>èµ„äº§å†…å®¹å¾…æ‰©å±•ã€‚</p>
    </section>
    <section id="liabilities" class="tab-content">
<div class="bg-white rounded-xl shadow p-6 space-y-4">
<div class="bg-white rounded-xl shadow p-6 space-y-4">
  <h2>æˆ‘çš„è´Ÿå€º</h2>
  <form id="debtForm" style="margin-bottom: 20px;">
    <input type="text" id="debtName" placeholder="è´Ÿå€ºåç§°ï¼ˆå¦‚ å»ºè®¾é“¶è¡Œä¿¡ç”¨å¡ï¼‰" required>
    <input type="number" id="debtAmount" placeholder="é‡‘é¢" required>
    <select id="debtCategory">
      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
      <option value="æˆ¿è´·">æˆ¿è´·</option>
      <option value="å€Ÿæ¬¾">å€Ÿæ¬¾</option>
    </select>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">æ·»åŠ è´Ÿå€º</button>
  </form>
  <div id="debtCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
  </div><div class="bg-white rounded-xl shadow p-4 mt-4"></div><div class="bg-white rounded-xl shadow p-4 mt-4"><canvas id="debtChart" height="180" style="margin-top: 30px;"></canvas>

      <h2>è´Ÿå€º</h2><p>è´Ÿå€ºå†…å®¹å¾…æ‰©å±•ã€‚</p>
    </section>
    <section id="reports" class="tab-content">
<div class="bg-white rounded-xl shadow p-6 space-y-6">
<div class="bg-white rounded-xl shadow p-6 space-y-6">
      <h2>æŠ¥è¡¨</h2><p>æœªæ¥å°†æ˜¾ç¤ºå›¾è¡¨åˆ†æã€‚</p>
    <canvas id="categoryChart" class="w-full max-w-2xl mx-auto" height="180"></canvas>
<canvas id="monthlyChart" class="w-full max-w-2xl mx-auto" height="180" style="margin-top: 30px;"></canvas>
</section>
</div></div>
<section id="profile" class="tab-content">
<div class="bg-white rounded-xl shadow p-6 space-y-4">
  <h2 class="text-xl font-semibold text-gray-800">è´¦æˆ·è®¾ç½®</h2>
  <div class="space-x-2">
    <button onclick="exportCSV('assets')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">å¯¼å‡ºèµ„äº§</button>
    <button onclick="exportCSV('debts')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">å¯¼å‡ºè´Ÿå€º</button>
    <button onclick="exportCSV('records')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">å¯¼å‡ºè®°è´¦è®°å½•</button>
  </div>
  <p class="text-sm text-gray-500">å¯¼å‡ºåå°†ä¸‹è½½ .csv æ–‡ä»¶ï¼Œå¯ç”¨ Excel æ‰“å¼€ã€‚</p>
  <hr>
  <h3 class="text-md font-medium text-gray-700">å¯¼å…¥æ•°æ®</h3>
  <input type="file" id="importFile" accept=".csv" class="w-full border rounded p-2">
  <button onclick="importCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mt-2">å¯¼å…¥æ•°æ®</button>
  <p class="text-xs text-gray-400">æ”¯æŒæ–‡ä»¶åï¼šassets.csvã€debts.csvã€records.csv</p>
</div>
  <h2>è´¦æˆ·è®¾ç½®</h2>
  <button onclick="exportCSV('assets')">å¯¼å‡ºèµ„äº§</button>
  <button onclick="exportCSV('debts')">å¯¼å‡ºè´Ÿå€º</button>
  <button onclick="exportCSV('records')">å¯¼å‡ºè®°è´¦è®°å½•</button>
  <p style="margin-top: 1rem;">å¯¼å‡ºåå°†ä¸‹è½½ .csv æ–‡ä»¶ï¼Œå¯ç”¨ Excel æ‰“å¼€ã€‚</p>
<hr style="margin: 20px 0;">
<h3>å¯¼å…¥æ•°æ®</h3>
<p>ä¸Šä¼  CSV æ–‡ä»¶ä»¥æ¢å¤æ•°æ®ï¼š</p>
<input type="file" id="importFile" accept=".csv">
<button onclick="importCSV()">å¯¼å…¥æ•°æ®</button>
<p style="font-size: 0.9rem; color: gray;">æ”¯æŒæ–‡ä»¶åï¼šassets.csvã€debts.csvã€records.csv</p>

      <h2>æˆ‘çš„</h2><p>ç”¨æˆ·è®¾ç½®ã€å¯¼å‡ºã€æ•°æ®ç®¡ç†ç­‰ã€‚</p>
    </section>
  </main>

  <script>
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.getAttribute('data-tab');
        tabButtons.forEach(btn => {
        btn.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold');
      });
        tabContents.forEach(content => content.classList.remove('active'));
        button.classList.add('bg-blue-100', 'text-blue-700', 'font-semibold');
        document.getElementById(target).classList.add('active');
      });
    });

    // æœ¬åœ°ä¿å­˜å’Œè¯»å–è®°å½•
    const form = document.getElementById('entryForm');
    const tableBody = document.querySelector('#recordTable tbody');

    function loadRecords() {
      const data = JSON.parse(localStorage.getItem('records') || '[]');
      tableBody.innerHTML = '';
      data.slice().reverse().forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="${item.type}">${item.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</td>
          <td class="p-2 border"${item.amount}</td>
          <td class="p-2 border"${item.category}</td>
          <td class="p-2 border"${item.date}</td>
          <td class="p-2 border"${item.note || ''}</td>
          <td class="p-2 border"<button onclick="deleteRecord(${index})">åˆ é™¤</button></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function saveRecord(e) {
      e.preventDefault();
      const type = document.getElementById('type').value;
      const amount = document.getElementById('amount').value;
      const category = document.getElementById('category').value;
      const date = document.getElementById('date').value;
      const note = document.getElementById('note').value;

      if (!amount || !date) return alert('è¯·å¡«å†™é‡‘é¢å’Œæ—¥æœŸ');

      const newItem = { type, amount, category, date, note };
      const records = JSON.parse(localStorage.getItem('records') || '[]');
      records.push(newItem);
      localStorage.setItem('records', JSON.stringify(records));
      form.reset();
      loadRecords();
    }

    function deleteRecord(index) {
      const records = JSON.parse(localStorage.getItem('records') || '[]');
      const realIndex = records.length - 1 - index;
      records.splice(realIndex, 1);
      localStorage.setItem('records', JSON.stringify(records));
      loadRecords();
    }

    window.deleteRecord = deleteRecord;
    form.addEventListener('submit', saveRecord);
    loadRecords();
  
// ç”Ÿæˆåˆ†ç±»é¥¼å›¾å’Œæœˆåº¦æŠ˜çº¿å›¾
function renderCharts() {
  const data = JSON.parse(localStorage.getItem('records') || '[]');

  // åˆ†ç±»æ±‡æ€»ï¼ˆæ”¶å…¥ vs æ”¯å‡ºï¼‰
  const incomeMap = {}, expenseMap = {};
  const monthlyMap = {};

  data.forEach(item => {
    const month = item.date?.slice(0, 7); // YYYY-MM
    const amt = parseFloat(item.amount);
    if (!month || isNaN(amt)) return;

    // åˆ†ç±»æ•°æ®
    const catMap = item.type === 'income' ? incomeMap : expenseMap;
    catMap[item.category] = (catMap[item.category] || 0) + amt;

    // æœˆåº¦æ•°æ®
    if (!monthlyMap[month]) monthlyMap[month] = { income: 0, expense: 0 };
    monthlyMap[month][item.type] += amt;
  });

  // é¥¼å›¾ - åˆ†ç±»
  const catLabels = Array.from(new Set([...Object.keys(expenseMap), ...Object.keys(incomeMap)]));
  const incomeData = catLabels.map(k => incomeMap[k] || 0);
  const expenseData = catLabels.map(k => expenseMap[k] || 0);

  new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
      labels: catLabels,
      datasets: [
        { label: 'æ”¯å‡º', data: expenseData, backgroundColor: '#ef4444' },
        { label: 'æ”¶å…¥', data: incomeData, backgroundColor: 'rgba(75,192,192,0.6)' }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: 'åˆ†ç±»æ”¶æ”¯å æ¯”' } }
    }
  });

  // æŠ˜çº¿å›¾ - æœˆåº¦è¶‹åŠ¿
  const months = Object.keys(monthlyMap).sort();
  const incomeTrend = months.map(m => monthlyMap[m].income);
  const expenseTrend = months.map(m => monthlyMap[m].expense);

  new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        { label: 'æ”¶å…¥', data: incomeTrend, borderColor: 'green', tension: 0.3 },
        { label: 'æ”¯å‡º', data: expenseTrend, borderColor: 'red', tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: 'æœˆåº¦æ”¶æ”¯è¶‹åŠ¿' } }
    }
  });
}

// æ¯æ¬¡åˆ‡æ¢åˆ°æŠ¥è¡¨é¡µé¢æ—¶åˆ·æ–°å›¾è¡¨
document.querySelector('[data-tab="reports"]').addEventListener('click', () => {
  setTimeout(renderCharts, 100); // å»¶è¿Ÿç¡®ä¿ canvas å·²æ¸²æŸ“
});

// ===== è´Ÿå€ºåŠŸèƒ½ =====
function loadDebts() {
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  const container = document.getElementById('debtCards');
  container.innerHTML = '';
  let summary = {};
  data.forEach((debt, index) => {
    summary[debt.category] = (summary[debt.category] || 0) + parseFloat(debt.amount);
    const card = document.createElement('div');
    card.className = 'bg-white shadow rounded-xl p-4 border-l-4 border-red-500';
    card.innerHTML = `<strong>${debt.name}</strong><br>Â¥${parseFloat(debt.amount).toFixed(2)}<br><small>${debt.category}</small><br><button onclick="deleteDebt(${index})" style='margin-top:5px;'>ğŸ—‘ åˆ é™¤</button>`;
    container.appendChild(card);
  });

  const ctx = document.getElementById('debtChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(summary),
        datasets: [{
          label: 'å„ç±»è´Ÿå€ºé‡‘é¢',
          data: Object.values(summary),
          backgroundColor: '#ef4444'
        }]
      },
      options: {
        plugins: { title: { display: true, text: 'è´Ÿå€ºåˆ†ç±»ç»Ÿè®¡å›¾' } },
        responsive: true
      }
    });
  }
}

document.getElementById('debtForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const name = document.getElementById('debtName').value;
  const amount = document.getElementById('debtAmount').value;
  const category = document.getElementById('debtCategory').value;
  if (!name || !amount) return alert('è¯·è¾“å…¥å®Œæ•´è´Ÿå€ºä¿¡æ¯');
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  let code = "";
  if (category === "è‚¡ç¥¨" || category === "åŸºé‡‘") {
    code = prompt("è¯·è¾“å…¥è‚¡ç¥¨/åŸºé‡‘ä»£ç ï¼ˆå¦‚ sh600519, usAAPL, hk0700, f110011ï¼‰", "");
    if (!code) return alert("è‚¡ç¥¨æˆ–åŸºé‡‘å¿…é¡»å¡«å†™ä»£ç ");
  }
  data.push({ name, amount, category, code });
  localStorage.setItem('debts', JSON.stringify(data));
  this.reset();
  loadDebts();
});

function deleteDebt(index) {
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  data.splice(index, 1);
  localStorage.setItem('debts', JSON.stringify(data));
  loadDebts();
}

document.querySelector('[data-tab="liabilities"]').addEventListener('click', () => {
  setTimeout(loadDebts, 100);
});

// ç¼–è¾‘è‚¡ç¥¨/åŸºé‡‘æŒä»“è‚¡æ•°
function editShares(index) {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  const asset = data[index];
  const input = prompt("è¯·è¾“å…¥æ–°çš„æŒä»“è‚¡æ•° / ä»½é¢ï¼š", asset.amount);
  if (!input || isNaN(input)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
  asset.amount = parseFloat(input).toFixed(2);
  localStorage.setItem('assets', JSON.stringify(data));
  loadAssets();
  fetchStockPrices();
}

// ===== èµ„äº§åŠŸèƒ½ =====
function loadAssets() {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  const container = document.getElementById('assetCards');
  container.innerHTML = '';
  let summary = {};
  let total = 0;
  data.forEach((asset, index) => {
    total += parseFloat(asset.amount);
    summary[asset.category] = (summary[asset.category] || 0) + parseFloat(asset.amount);
    const card = document.createElement('div');
    card.className = 'bg-white shadow rounded-xl p-4 border-l-4 border-blue-500';
    if (asset.category === 'è‚¡ç¥¨' || asset.category === 'åŸºé‡‘') {
      card.setAttribute('data-code', (asset.code || '').toLowerCase());
      card.setAttribute('data-shares', asset.amount);
      card.innerHTML = `<strong>${asset.name}</strong>
  <br><span class="price text-sm text-gray-600">æ­£åœ¨åŠ è½½ä»·æ ¼...</span>
  <br><span class="value font-semibold text-blue-600">å¸‚å€¼ --</span>
  <br><small>${asset.category} Â· ${asset.code}</small>
  <br><button onclick="editShares(${index})" class="mt-1 mr-2 text-blue-600 hover:underline text-sm">âœï¸ ç¼–è¾‘</button>
  <button onclick="deleteAsset(${index})" class="mt-1 text-red-600 hover:underline text-sm">ğŸ—‘ åˆ é™¤</button>`;
        <br><span class="price text-sm text-gray-600">æ­£åœ¨åŠ è½½ä»·æ ¼...</span>
        <br><span class="value font-semibold text-blue-600">å¸‚å€¼ --</span>
        <br><small>${asset.category} Â· ${asset.code}</small>
        <br><button onclick="deleteAsset(${index})" class="mt-2 text-red-600 hover:underline text-sm">ğŸ—‘ åˆ é™¤</button>`;
    } else {
      card.innerHTML = `<strong>${asset.name}</strong>
  <br><span class="price text-sm text-gray-600">æ­£åœ¨åŠ è½½ä»·æ ¼...</span>
  <br><span class="value font-semibold text-blue-600">å¸‚å€¼ --</span>
  <br><small>${asset.category} Â· ${asset.code}</small>
  <br><button onclick="editShares(${index})" class="mt-1 mr-2 text-blue-600 hover:underline text-sm">âœï¸ ç¼–è¾‘</button>
  <button onclick="deleteAsset(${index})" class="mt-1 text-red-600 hover:underline text-sm">ğŸ—‘ åˆ é™¤</button>`;<br>Â¥${parseFloat(asset.amount).toFixed(2)}<br><small>${asset.category}</small><br><button onclick="deleteAsset(${index})" class="mt-2 text-red-600 hover:underline text-sm">ğŸ—‘ åˆ é™¤</button>`;
    } onclick="deleteAsset(${index})" style='margin-top:5px;'>ğŸ—‘ åˆ é™¤</button>`;
    container.appendChild(card);
  });

  // åˆ†ç±»ç»Ÿè®¡å›¾è¡¨
  const ctx = document.getElementById('assetChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(summary),
        datasets: [{
          label: 'å„ç±»èµ„äº§é‡‘é¢',
          data: Object.values(summary),
          backgroundColor: '#3b82f6'
        }]
      },
      options: {
        plugins: { title: { display: true, text: 'èµ„äº§åˆ†ç±»ç»Ÿè®¡å›¾' } },
        responsive: true
      }
    });
  }
}

document.getElementById('assetForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const name = document.getElementById('assetName').value;
  const amount = document.getElementById('assetAmount').value;
  const category = document.getElementById('assetCategory').value;
  if (!name || !amount) return alert('è¯·è¾“å…¥å®Œæ•´èµ„äº§ä¿¡æ¯');
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  let code = "";
  if (category === "è‚¡ç¥¨" || category === "åŸºé‡‘") {
    code = prompt("è¯·è¾“å…¥è‚¡ç¥¨/åŸºé‡‘ä»£ç ï¼ˆå¦‚ sh600519, usAAPL, hk0700, f110011ï¼‰", "");
    if (!code) return alert("è‚¡ç¥¨æˆ–åŸºé‡‘å¿…é¡»å¡«å†™ä»£ç ");
  }
  data.push({ name, amount, category, code });
  localStorage.setItem('assets', JSON.stringify(data));
  this.reset();
  loadAssets();
});

// åˆ é™¤èµ„äº§å‡½æ•°
function deleteAsset(index) {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  data.splice(index, 1);
  localStorage.setItem('assets', JSON.stringify(data));
  loadAssets();
}

// åŠ è½½èµ„äº§æ•°æ®
document.querySelector('[data-tab="assets"]').addEventListener('click', () => {
  setTimeout(loadAssets, 100);
});

// ===== CSV å¯¼å‡ºåŠŸèƒ½ =====
function exportCSV(type) {
  const map = {
    assets: ['name', 'amount', 'category'],
    debts: ['name', 'amount', 'category'],
    records: ['type', 'amount', 'category', 'date', 'note']
  };
  const headers = map[type];
  const data = JSON.parse(localStorage.getItem(type) || '[]');
  if (!data.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');

  const csvRows = [headers.join(',')];
  data.forEach(item => {
    const row = headers.map(h => `"${(item[h] ?? '').toString().replace(/"/g, '""')}"`);
    csvRows.push(row.join(','));
  });
  const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${type}.csv`;
  link.click();
}

// ===== CSV å¯¼å…¥åŠŸèƒ½ =====
function importCSV() {
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if (!file || !file.name.endsWith('.csv')) return alert('è¯·é€‰æ‹©ä¸€ä¸ª CSV æ–‡ä»¶');

  const reader = new FileReader();
  reader.onload = function (e) {
    const lines = e.target.result.split('\n').filter(l => l.trim());
    const headers = lines[0].split(',').map(h => h.trim());
    const records = lines.slice(1).map(line => {
      const cols = line.split(',');
      const item = {};
      headers.forEach((h, i) => item[h] = cols[i]?.replace(/^"|"$/g, '').trim());
      return item;
    });

    let key = '';
    if (file.name.startsWith('assets')) key = 'assets';
    else if (file.name.startsWith('debts')) key = 'debts';
    else if (file.name.startsWith('records')) key = 'records';
    else return alert('æ–‡ä»¶åå¿…é¡»ä¸º assets.csvã€debts.csv æˆ– records.csv');

    localStorage.setItem(key, JSON.stringify(records));
    alert('å¯¼å…¥æˆåŠŸï¼š' + file.name);
  };
  reader.readAsText(file);
}
// ===== ç†è´¢æœˆå†åŠŸèƒ½ =====
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-11

function changeMonth(offset) {
  currentMonth += offset;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  generateCalendar();
updateBudgetBar();
}å¹´${month + 1}æœˆ`;

  // è·å–æœ‰è®°è´¦è®°å½•çš„æ—¥æœŸé›†åˆ
  const records = JSON.parse(localStorage.getItem('records') || '[]');
  const markedDates = new Set(records.map(r => r.date));

  // å¡«å……ç©ºç™½
  for (let i = 0; i < startWeekday; i++) {
    const empty = document.createElement('div');
    calendarGrid.appendChild(empty);
  }

  // å¡«å……æ—¥æœŸ
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    const cell = document.createElement('div');
    cell.textContent = d;
    cell.style.padding = '10px';
    cell.style.textAlign = 'center';
    cell.style.borderRadius = '4px';
    cell.style.border = '1px solid #eee';
    if (markedDates.has(dateStr)) {
      cell.style.backgroundColor = '#165DFF';
      cell.style.color = '#fff';
      cell.style.fontWeight = 'bold';
    }
    calendarGrid.appendChild(cell);
  }
}

generateCalendar();
updateBudgetBar();
// ===== æœˆåº¦é¢„ç®—è¿›åº¦æ¡ =====
function updateBudgetBar() {
  const records = JSON.parse(localStorage.getItem('records') || '[]');
  const year = currentYear;
  const month = (currentMonth + 1).toString().padStart(2, '0');
  const prefix = `${year}-${month}`;
  const expenses = records
    .filter(r => r.type === 'expense' && r.date?.startsWith(prefix))
    .reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
  const budget = 5000; // é»˜è®¤é¢„ç®—ï¼Œå¯æ”¹ä¸ºå¯è®¾ç½®
  const percent = Math.min((expenses / budget) * 100, 100).toFixed(1);
  const bar = document.getElementById('budgetBar');
  bar.style.width = percent + '%';
  bar.textContent = `Â¥${expenses.toFixed(2)} / Â¥${budget}`;
  bar.style.backgroundColor = percent > 80 ? '#f44336' : '#165DFF';
}

function fetchStockPrices() {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  const codes = data.filter(a => a.category === 'è‚¡ç¥¨' || a.category === 'åŸºé‡‘')
    .map(a => a.code?.toLowerCase()).filter(Boolean);

  if (codes.length === 0) return;

  const url = 'https://qt.gtimg.cn/q=' + codes.join(',');
  fetch(url)
    .then(res => res.text())
    .then(text => {
      codes.forEach(code => {
        const match = text.match(new RegExp(`v_${code}="(.*?)";`));
        if (!match) return;
        const parts = match[1].split('~');
        const price = parseFloat(parts[3]);
        const name = parts[1];
        document.querySelectorAll(`[data-code="${code}"]`).forEach(card => {
          const shares = parseFloat(card.getAttribute('data-shares'));
          const value = (price * shares).toFixed(2);
          card.querySelector('.price').textContent = `ç°ä»· Â¥${price}`;
          card.querySelector('.value').textContent = `å¸‚å€¼ Â¥${value}`;
        });
      });
    });
}
setInterval(fetchStockPrices, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
document.querySelector('[data-tab="assets"]').addEventListener('click', () => {
  setTimeout(() => {
    loadAssets();
    fetchStockPrices();
  }, 100);
});
</script>
</body>
</html>
