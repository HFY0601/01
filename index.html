
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>资产领航</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-sm text-gray-800">
  <header class="bg-white shadow px-4 py-3 sticky top-0 z-10">
    <h1 class="text-lg font-semibold">资产领航 · 简版测试</h1>
  </header>

  <main class="p-4">
    <section id="assets" class="space-y-4">
      <h2 class="text-xl font-bold">我的资产</h2>
      <form id="assetForm" class="space-y-2 bg-white rounded shadow p-4">
        <input type="text" id="assetName" placeholder="名称" class="w-full border rounded p-2" required />
        <input type="number" id="assetAmount" placeholder="数量/金额" class="w-full border rounded p-2" required />
        <select id="assetCategory" class="w-full border rounded p-2">
          <option value="现金">现金</option>
          <option value="银行">银行</option>
          <option value="股票">股票</option>
        </select>
        <input type="text" id="assetCode" placeholder="股票代码（如 sh600519）" class="w-full border rounded p-2" />
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">添加资产</button>
      </form>
      <div id="assetCards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>
  </main>

  <script>
    const assetForm = document.getElementById('assetForm');
    const assetCards = document.getElementById('assetCards');

    assetForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = assetForm.assetName.value.trim();
      const amount = parseFloat(assetForm.assetAmount.value);
      const category = assetForm.assetCategory.value;
      const code = assetForm.assetCode.value.trim();
      if (!name || isNaN(amount)) return alert("请输入正确的资产信息");

      const assets = JSON.parse(localStorage.getItem('assets') || '[]');
      assets.push({ name, amount, category, code });
      localStorage.setItem('assets', JSON.stringify(assets));
      assetForm.reset();
      loadAssets();
    });

    function loadAssets() {
      const assets = JSON.parse(localStorage.getItem('assets') || '[]');
      assetCards.innerHTML = '';
      assets.forEach((a, i) => {
        const card = document.createElement('div');
        card.className = "bg-white rounded shadow p-4 border-l-4 " + (a.category === '股票' ? "border-blue-500" : "border-green-500");
        card.setAttribute('data-code', a.code?.toLowerCase() || '');
        card.setAttribute('data-amount', a.amount);
        card.innerHTML = '<strong>' + a.name + '</strong><br>' +
          '<span class="price text-sm text-gray-500">正在获取价格</span><br>' +
          '<span class="value text-blue-600 font-bold">--</span><br>' +
          '<small>' + a.category + ' ' + (a.code || '') + '</small>';
        assetCards.appendChild(card);
      });
      fetchStockPrices();
    }

    function fetchStockPrices() {
      const assets = JSON.parse(localStorage.getItem('assets') || '[]');
      const codes = assets.filter(a => a.category === '股票' && a.code).map(a => a.code.toLowerCase());
      if (codes.length === 0) return;
      fetch('https://qt.gtimg.cn/q=' + codes.join(','))
        .then(res => res.text())
        .then(text => {
          codes.forEach(code => {
            const match = text.match(new RegExp('v_' + code + '="(.*?)";'));
            if (!match) return;
            const parts = match[1].split('~');
            const price = parseFloat(parts[3]);
            document.querySelectorAll('[data-code="' + code + '"]').forEach(card => {
              const amt = parseFloat(card.getAttribute('data-amount'));
              card.querySelector('.price').textContent = '现价 ¥' + price;
              card.querySelector('.value').textContent = '市值 ¥' + (amt * price).toFixed(2);
            });
          });
        });
    }

    loadAssets();
    setInterval(fetchStockPrices, 60000);
  </script>
</body>
</html>
