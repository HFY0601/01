
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
// 生成分类饼图和月度折线图
function renderCharts() {
  const data = JSON.parse(localStorage.getItem('records') || '[]');

  // 分类汇总（收入 vs 支出）
  const incomeMap = {}, expenseMap = {};
  const monthlyMap = {};

  data.forEach(item => {
    const month = item.date?.slice(0, 7); // YYYY-MM
    const amt = parseFloat(item.amount);
    if (!month || isNaN(amt)) return;

    // 分类数据
    const catMap = item.type === 'income' ? incomeMap : expenseMap;
    catMap[item.category] = (catMap[item.category] || 0) + amt;

    // 月度数据
    if (!monthlyMap[month]) monthlyMap[month] = { income: 0, expense: 0 };
    monthlyMap[month][item.type] += amt;
  });

  // 饼图 - 分类
  const catLabels = Array.from(new Set([...Object.keys(expenseMap), ...Object.keys(incomeMap)]));
  const incomeData = catLabels.map(k => incomeMap[k] || 0);
  const expenseData = catLabels.map(k => expenseMap[k] || 0);

  new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
      labels: catLabels,
      datasets: [
        { label: '支出', data: expenseData, backgroundColor: 'rgba(255,99,132,0.6)' },
        { label: '收入', data: incomeData, backgroundColor: 'rgba(75,192,192,0.6)' }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: '分类收支占比' } }
    }
  });

  // 折线图 - 月度趋势
  const months = Object.keys(monthlyMap).sort();
  const incomeTrend = months.map(m => monthlyMap[m].income);
  const expenseTrend = months.map(m => monthlyMap[m].expense);

  new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        { label: '收入', data: incomeTrend, borderColor: 'green', tension: 0.3 },
        { label: '支出', data: expenseTrend, borderColor: 'red', tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: '月度收支趋势' } }
    }
  });
}

// 每次切换到报表页面时刷新图表
document.querySelector('[data-tab="reports"]').addEventListener('click', () => {
  setTimeout(renderCharts, 100); // 延迟确保 canvas 已渲染
});

// ===== 负债功能 =====
function loadDebts() {
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  const container = document.getElementById('debtCards');
  container.innerHTML = '';
  let summary = {};
  data.forEach((debt, index) => {
    summary[debt.category] = (summary[debt.category] || 0) + parseFloat(debt.amount);
    const card = document.createElement('div');
    card.style.background = '#fff3f3';
    card.style.padding = '10px';
    card.style.borderRadius = '6px';
    card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';
    card.innerHTML = `<strong>${debt.name}</strong><br>¥${parseFloat(debt.amount).toFixed(2)}<br><small>${debt.category}</small><br><button onclick="deleteDebt(${index})" style='margin-top:5px;'>🗑 删除</button>`;
    container.appendChild(card);
  });

  const ctx = document.getElementById('debtChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(summary),
        datasets: [{
          label: '各类负债金额',
          data: Object.values(summary),
          backgroundColor: 'rgba(255,99,132,0.6)'
        }]
      },
      options: {
        plugins: { title: { display: true, text: '负债分类统计图' } },
        responsive: true
      }
    });
  }
}

document.getElementById('debtForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const name = document.getElementById('debtName').value;
  const amount = document.getElementById('debtAmount').value;
  const category = document.getElementById('debtCategory').value;
  if (!name || !amount) return alert('请输入完整负债信息');
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  data.push({ name, amount, category });
  localStorage.setItem('debts', JSON.stringify(data));
  this.reset();
  loadDebts();
});

function deleteDebt(index) {
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  data.splice(index, 1);
  localStorage.setItem('debts', JSON.stringify(data));
  loadDebts();
}

document.querySelector('[data-tab="liabilities"]').addEventListener('click', () => {
  setTimeout(loadDebts, 100);
});

// ===== 资产功能 =====
function loadAssets() {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  const container = document.getElementById('assetCards');
  container.innerHTML = '';
  let summary = {};
  let total = 0;
  data.forEach(asset => {
    total += parseFloat(asset.amount);
    summary[asset.category] = (summary[asset.category] || 0) + parseFloat(asset.amount);
    const card = document.createElement('div');
    card.style.background = '#f4f4f8';
    card.style.padding = '10px';
    card.style.borderRadius = '6px';
    card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';
    card.innerHTML = `<strong>${asset.name}</strong><br>¥${parseFloat(asset.amount).toFixed(2)}<br><small>${asset.category}</small><br><button onclick="deleteAsset(${index})" style='margin-top:5px;'>🗑 删除</button>`;
    container.appendChild(card);
  });

  // 分类统计图表
  const ctx = document.getElementById('assetChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(summary),
        datasets: [{
          label: '各类资产金额',
          data: Object.values(summary),
          backgroundColor: 'rgba(54,162,235,0.6)'
        }]
      },
      options: {
        plugins: { title: { display: true, text: '资产分类统计图' } },
        responsive: true
      }
    });
  }
}

document.getElementById('assetForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const name = document.getElementById('assetName').value;
  const amount = document.getElementById('assetAmount').value;
  const category = document.getElementById('assetCategory').value;
  if (!name || !amount) return alert('请输入完整资产信息');
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  data.push({ name, amount, category });
  localStorage.setItem('assets', JSON.stringify(data));
  this.reset();
  loadAssets();
});

// 删除资产函数
function deleteAsset(index) {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  data.splice(index, 1);
  localStorage.setItem('assets', JSON.stringify(data));
  loadAssets();
}

// 加载资产数据
document.querySelector('[data-tab="assets"]').addEventListener('click', () => {
  setTimeout(loadAssets, 100);
});

// ===== CSV 导出功能 =====
function exportCSV(type) {
  const map = {
    assets: ['name', 'amount', 'category'],
    debts: ['name', 'amount', 'category'],
    records: ['type', 'amount', 'category', 'date', 'note']
  };
  const headers = map[type];
  const data = JSON.parse(localStorage.getItem(type) || '[]');
  if (!data.length) return alert('没有可导出的数据');

  const csvRows = [headers.join(',')];
  data.forEach(item => {
    const row = headers.map(h => `"${(item[h] ?? '').toString().replace(/"/g, '""')}"`);
    csvRows.push(row.join(','));
  });
  const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${type}.csv`;
  link.click();
}

// ===== CSV 导入功能 =====
function importCSV() {
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if (!file || !file.name.endsWith('.csv')) return alert('请选择一个 CSV 文件');

  const reader = new FileReader();
  reader.onload = function (e) {
    const lines = e.target.result.split('\n').filter(l => l.trim());
    const headers = lines[0].split(',').map(h => h.trim());
    const records = lines.slice(1).map(line => {
      const cols = line.split(',');
      const item = {};
      headers.forEach((h, i) => item[h] = cols[i]?.replace(/^"|"$/g, '').trim());
      return item;
    });

    let key = '';
    if (file.name.startsWith('assets')) key = 'assets';
    else if (file.name.startsWith('debts')) key = 'debts';
    else if (file.name.startsWith('records')) key = 'records';
    else return alert('文件名必须为 assets.csv、debts.csv 或 records.csv');

    localStorage.setItem(key, JSON.stringify(records));
    alert('导入成功：' + file.name);
  };
  reader.readAsText(file);
}
// ===== 理财月历功能 =====
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-11

function changeMonth(offset) {
  currentMonth += offset;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  generateCalendar();
}

function generateCalendar() {
  const year = currentYear;
  const month = currentMonth;
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startWeekday = firstDay.getDay(); // 0 (Sun) - 6 (Sat)
  const calendarGrid = document.getElementById('calendarGrid');
  const calendarMonth = document.getElementById('calendarMonth');

  calendarGrid.innerHTML = '';
  calendarMonth.textContent = `${year}年${month + 1}月`;

  // 获取有记账记录的日期集合
  const records = JSON.parse(localStorage.getItem('records') || '[]');
  const markedDates = new Set(records.map(r => r.date));

  // 填充空白
  for (let i = 0; i < startWeekday; i++) {
    const empty = document.createElement('div');
    calendarGrid.appendChild(empty);
  }

  // 填充日期
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    const cell = document.createElement('div');
    cell.textContent = d;
    cell.style.padding = '10px';
    cell.style.textAlign = 'center';
    cell.style.borderRadius = '4px';
    cell.style.border = '1px solid #eee';
    if (markedDates.has(dateStr)) {
      cell.style.backgroundColor = '#165DFF';
      cell.style.color = '#fff';
      cell.style.fontWeight = 'bold';
    }
    calendarGrid.appendChild(cell);
  }
}

generateCalendar();
</script>
  <meta charset="UTF-8">
  <title>极简理财 - 记账功能</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 0; background: #f5f6f8; }
    header { background: white; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 1.25rem; }
    nav { display: flex; border-bottom: 1px solid #ddd; }
    .tab-btn {
      flex: 1; padding: 12px; text-align: center; cursor: pointer;
      border-bottom: 2px solid transparent; font-weight: bold; background: #fff;
    }
    .tab-btn.active { border-color: #165DFF; color: #165DFF; }
    main { padding: 20px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }

    form input, form select, form button {
      padding: 8px; margin: 6px 0; width: 100%; box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 0.9rem; }
    th { background: #f0f0f0; }
    .income { color: green; }
    .expense { color: red; }
  </style>
</head>
<body>
  <header>
    <h1>极简理财</h1>
  </header>
  <nav>
    <div class="tab-btn active" data-tab="dashboard">总览</div>
    <div class="tab-btn" data-tab="assets">资产</div>
    <div class="tab-btn" data-tab="liabilities">负债</div>
    <div class="tab-btn" data-tab="reports">报表</div>
    <div class="tab-btn" data-tab="profile">我的</div>
  </nav>
  <main>
    <section id="dashboard" class="tab-content active">
      <h2>理财月历</h2>
  <div id="calendarContainer" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <button onclick="changeMonth(-1)">◀ 上月</button>
      <h3 id="calendarMonth" style="margin: 0;"></h3>
      <button onclick="changeMonth(1)">下月 ▶</button>
    </div>
    <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;"></div>
  </div>
  <h2>快速记账</h2>
      <form id="entryForm">
        <select id="type">
          <option value="expense">支出</option>
          <option value="income">收入</option>
        </select>
        <input type="number" id="amount" placeholder="金额 (必填)" required>
        <select id="category">
          <option value="餐饮">餐饮</option>
          <option value="交通">交通</option>
          <option value="工资">工资</option>
          <option value="其他">其他</option>
        </select>
        <input type="date" id="date" required>
        <input type="text" id="note" placeholder="备注（选填）">
        <button type="submit">保存记录</button>
      </form>

      <h3>最近记录</h3>
      <table id="recordTable">
        <thead>
          <tr>
            <th>类型</th><th>金额</th><th>分类</th><th>日期</th><th>备注</th><th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="assets" class="tab-content">
  <h2>我的资产</h2>
  <form id="assetForm" style="margin-bottom: 20px;">
    <input type="text" id="assetName" placeholder="资产名称（如 工商银行卡）" required>
    <input type="number" id="assetAmount" placeholder="金额" required>
    <select id="assetCategory">
      <option value="现金">现金</option>
      <option value="储蓄">储蓄</option>
      <option value="投资">投资</option>
      <option value="数字资产">数字资产</option>
    </select>
    <button type="submit">添加资产</button>
  </form>
  <div id="assetCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
  <canvas id="assetChart" height="180" style="margin-top: 30px;"></canvas>

      <h2>资产</h2><p>资产内容待扩展。</p>
    </section>
    <section id="liabilities" class="tab-content">
  <h2>我的负债</h2>
  <form id="debtForm" style="margin-bottom: 20px;">
    <input type="text" id="debtName" placeholder="负债名称（如 建设银行信用卡）" required>
    <input type="number" id="debtAmount" placeholder="金额" required>
    <select id="debtCategory">
      <option value="信用卡">信用卡</option>
      <option value="房贷">房贷</option>
      <option value="借款">借款</option>
    </select>
    <button type="submit">添加负债</button>
  </form>
  <div id="debtCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
  <canvas id="debtChart" height="180" style="margin-top: 30px;"></canvas>

      <h2>负债</h2><p>负债内容待扩展。</p>
    </section>
    <section id="reports" class="tab-content">
      <h2>报表</h2><p>未来将显示图表分析。</p>
    <canvas id="categoryChart" height="180"></canvas>
<canvas id="monthlyChart" height="180" style="margin-top: 30px;"></canvas>
</section>
<section id="profile" class="tab-content">
  <h2>账户设置</h2>
  <button onclick="exportCSV('assets')">导出资产</button>
  <button onclick="exportCSV('debts')">导出负债</button>
  <button onclick="exportCSV('records')">导出记账记录</button>
  <p style="margin-top: 1rem;">导出后将下载 .csv 文件，可用 Excel 打开。</p>
<hr style="margin: 20px 0;">
<h3>导入数据</h3>
<p>上传 CSV 文件以恢复数据：</p>
<input type="file" id="importFile" accept=".csv">
<button onclick="importCSV()">导入数据</button>
<p style="font-size: 0.9rem; color: gray;">支持文件名：assets.csv、debts.csv、records.csv</p>

      <h2>我的</h2><p>用户设置、导出、数据管理等。</p>
    </section>
  </main>

  <script>
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.getAttribute('data-tab');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    // 本地保存和读取记录
    const form = document.getElementById('entryForm');
    const tableBody = document.querySelector('#recordTable tbody');

    function loadRecords() {
      const data = JSON.parse(localStorage.getItem('records') || '[]');
      tableBody.innerHTML = '';
      data.slice().reverse().forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="${item.type}">${item.type === 'income' ? '收入' : '支出'}</td>
          <td>${item.amount}</td>
          <td>${item.category}</td>
          <td>${item.date}</td>
          <td>${item.note || ''}</td>
          <td><button onclick="deleteRecord(${index})">删除</button></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function saveRecord(e) {
      e.preventDefault();
      const type = document.getElementById('type').value;
      const amount = document.getElementById('amount').value;
      const category = document.getElementById('category').value;
      const date = document.getElementById('date').value;
      const note = document.getElementById('note').value;

      if (!amount || !date) return alert('请填写金额和日期');

      const newItem = { type, amount, category, date, note };
      const records = JSON.parse(localStorage.getItem('records') || '[]');
      records.push(newItem);
      localStorage.setItem('records', JSON.stringify(records));
      form.reset();
      loadRecords();
    }

    function deleteRecord(index) {
      const records = JSON.parse(localStorage.getItem('records') || '[]');
      const realIndex = records.length - 1 - index;
      records.splice(realIndex, 1);
      localStorage.setItem('records', JSON.stringify(records));
      loadRecords();
    }

    window.deleteRecord = deleteRecord;
    form.addEventListener('submit', saveRecord);
    loadRecords();
  
// 生成分类饼图和月度折线图
function renderCharts() {
  const data = JSON.parse(localStorage.getItem('records') || '[]');

  // 分类汇总（收入 vs 支出）
  const incomeMap = {}, expenseMap = {};
  const monthlyMap = {};

  data.forEach(item => {
    const month = item.date?.slice(0, 7); // YYYY-MM
    const amt = parseFloat(item.amount);
    if (!month || isNaN(amt)) return;

    // 分类数据
    const catMap = item.type === 'income' ? incomeMap : expenseMap;
    catMap[item.category] = (catMap[item.category] || 0) + amt;

    // 月度数据
    if (!monthlyMap[month]) monthlyMap[month] = { income: 0, expense: 0 };
    monthlyMap[month][item.type] += amt;
  });

  // 饼图 - 分类
  const catLabels = Array.from(new Set([...Object.keys(expenseMap), ...Object.keys(incomeMap)]));
  const incomeData = catLabels.map(k => incomeMap[k] || 0);
  const expenseData = catLabels.map(k => expenseMap[k] || 0);

  new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
      labels: catLabels,
      datasets: [
        { label: '支出', data: expenseData, backgroundColor: 'rgba(255,99,132,0.6)' },
        { label: '收入', data: incomeData, backgroundColor: 'rgba(75,192,192,0.6)' }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: '分类收支占比' } }
    }
  });

  // 折线图 - 月度趋势
  const months = Object.keys(monthlyMap).sort();
  const incomeTrend = months.map(m => monthlyMap[m].income);
  const expenseTrend = months.map(m => monthlyMap[m].expense);

  new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        { label: '收入', data: incomeTrend, borderColor: 'green', tension: 0.3 },
        { label: '支出', data: expenseTrend, borderColor: 'red', tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: '月度收支趋势' } }
    }
  });
}

// 每次切换到报表页面时刷新图表
document.querySelector('[data-tab="reports"]').addEventListener('click', () => {
  setTimeout(renderCharts, 100); // 延迟确保 canvas 已渲染
});

// ===== 负债功能 =====
function loadDebts() {
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  const container = document.getElementById('debtCards');
  container.innerHTML = '';
  let summary = {};
  data.forEach((debt, index) => {
    summary[debt.category] = (summary[debt.category] || 0) + parseFloat(debt.amount);
    const card = document.createElement('div');
    card.style.background = '#fff3f3';
    card.style.padding = '10px';
    card.style.borderRadius = '6px';
    card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';
    card.innerHTML = `<strong>${debt.name}</strong><br>¥${parseFloat(debt.amount).toFixed(2)}<br><small>${debt.category}</small><br><button onclick="deleteDebt(${index})" style='margin-top:5px;'>🗑 删除</button>`;
    container.appendChild(card);
  });

  const ctx = document.getElementById('debtChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(summary),
        datasets: [{
          label: '各类负债金额',
          data: Object.values(summary),
          backgroundColor: 'rgba(255,99,132,0.6)'
        }]
      },
      options: {
        plugins: { title: { display: true, text: '负债分类统计图' } },
        responsive: true
      }
    });
  }
}

document.getElementById('debtForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const name = document.getElementById('debtName').value;
  const amount = document.getElementById('debtAmount').value;
  const category = document.getElementById('debtCategory').value;
  if (!name || !amount) return alert('请输入完整负债信息');
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  data.push({ name, amount, category });
  localStorage.setItem('debts', JSON.stringify(data));
  this.reset();
  loadDebts();
});

function deleteDebt(index) {
  const data = JSON.parse(localStorage.getItem('debts') || '[]');
  data.splice(index, 1);
  localStorage.setItem('debts', JSON.stringify(data));
  loadDebts();
}

document.querySelector('[data-tab="liabilities"]').addEventListener('click', () => {
  setTimeout(loadDebts, 100);
});

// ===== 资产功能 =====
function loadAssets() {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  const container = document.getElementById('assetCards');
  container.innerHTML = '';
  let summary = {};
  let total = 0;
  data.forEach(asset => {
    total += parseFloat(asset.amount);
    summary[asset.category] = (summary[asset.category] || 0) + parseFloat(asset.amount);
    const card = document.createElement('div');
    card.style.background = '#f4f4f8';
    card.style.padding = '10px';
    card.style.borderRadius = '6px';
    card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';
    card.innerHTML = `<strong>${asset.name}</strong><br>¥${parseFloat(asset.amount).toFixed(2)}<br><small>${asset.category}</small><br><button onclick="deleteAsset(${index})" style='margin-top:5px;'>🗑 删除</button>`;
    container.appendChild(card);
  });

  // 分类统计图表
  const ctx = document.getElementById('assetChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(summary),
        datasets: [{
          label: '各类资产金额',
          data: Object.values(summary),
          backgroundColor: 'rgba(54,162,235,0.6)'
        }]
      },
      options: {
        plugins: { title: { display: true, text: '资产分类统计图' } },
        responsive: true
      }
    });
  }
}

document.getElementById('assetForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const name = document.getElementById('assetName').value;
  const amount = document.getElementById('assetAmount').value;
  const category = document.getElementById('assetCategory').value;
  if (!name || !amount) return alert('请输入完整资产信息');
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  data.push({ name, amount, category });
  localStorage.setItem('assets', JSON.stringify(data));
  this.reset();
  loadAssets();
});

// 删除资产函数
function deleteAsset(index) {
  const data = JSON.parse(localStorage.getItem('assets') || '[]');
  data.splice(index, 1);
  localStorage.setItem('assets', JSON.stringify(data));
  loadAssets();
}

// 加载资产数据
document.querySelector('[data-tab="assets"]').addEventListener('click', () => {
  setTimeout(loadAssets, 100);
});

// ===== CSV 导出功能 =====
function exportCSV(type) {
  const map = {
    assets: ['name', 'amount', 'category'],
    debts: ['name', 'amount', 'category'],
    records: ['type', 'amount', 'category', 'date', 'note']
  };
  const headers = map[type];
  const data = JSON.parse(localStorage.getItem(type) || '[]');
  if (!data.length) return alert('没有可导出的数据');

  const csvRows = [headers.join(',')];
  data.forEach(item => {
    const row = headers.map(h => `"${(item[h] ?? '').toString().replace(/"/g, '""')}"`);
    csvRows.push(row.join(','));
  });
  const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${type}.csv`;
  link.click();
}

// ===== CSV 导入功能 =====
function importCSV() {
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if (!file || !file.name.endsWith('.csv')) return alert('请选择一个 CSV 文件');

  const reader = new FileReader();
  reader.onload = function (e) {
    const lines = e.target.result.split('\n').filter(l => l.trim());
    const headers = lines[0].split(',').map(h => h.trim());
    const records = lines.slice(1).map(line => {
      const cols = line.split(',');
      const item = {};
      headers.forEach((h, i) => item[h] = cols[i]?.replace(/^"|"$/g, '').trim());
      return item;
    });

    let key = '';
    if (file.name.startsWith('assets')) key = 'assets';
    else if (file.name.startsWith('debts')) key = 'debts';
    else if (file.name.startsWith('records')) key = 'records';
    else return alert('文件名必须为 assets.csv、debts.csv 或 records.csv');

    localStorage.setItem(key, JSON.stringify(records));
    alert('导入成功：' + file.name);
  };
  reader.readAsText(file);
}
// ===== 理财月历功能 =====
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-11

function changeMonth(offset) {
  currentMonth += offset;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  generateCalendar();
}

function generateCalendar() {
  const year = currentYear;
  const month = currentMonth;
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startWeekday = firstDay.getDay(); // 0 (Sun) - 6 (Sat)
  const calendarGrid = document.getElementById('calendarGrid');
  const calendarMonth = document.getElementById('calendarMonth');

  calendarGrid.innerHTML = '';
  calendarMonth.textContent = `${year}年${month + 1}月`;

  // 获取有记账记录的日期集合
  const records = JSON.parse(localStorage.getItem('records') || '[]');
  const markedDates = new Set(records.map(r => r.date));

  // 填充空白
  for (let i = 0; i < startWeekday; i++) {
    const empty = document.createElement('div');
    calendarGrid.appendChild(empty);
  }

  // 填充日期
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    const cell = document.createElement('div');
    cell.textContent = d;
    cell.style.padding = '10px';
    cell.style.textAlign = 'center';
    cell.style.borderRadius = '4px';
    cell.style.border = '1px solid #eee';
    if (markedDates.has(dateStr)) {
      cell.style.backgroundColor = '#165DFF';
      cell.style.color = '#fff';
      cell.style.fontWeight = 'bold';
    }
    calendarGrid.appendChild(cell);
  }
}

generateCalendar();
</script>
</body>
</html>
